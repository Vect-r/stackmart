{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Profile | Stackmart{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-12">

    <div id="ajax-message-container" class="mb-6 space-y-2"></div>

    <div
        class="relative bg-white dark:bg-[#18181b] rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-800 overflow-hidden">

        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-brand-pink via-brand-purple to-brand-cyan">
        </div>

        <div class="p-8 md:p-10 border-b border-gray-100 dark:border-gray-800">
            <div class="flex flex-col md:flex-row items-center gap-6 md:gap-8">

                <div class="relative group flex-shrink-0">
                    <!-- <img id="avatar-preview" 
                         src="{{user.profile.url}}" 
                         data-original-src="{{user.profile.url}}"
                         alt="User Avatar" 
                         class="w-24 h-24 md:w-32 md:h-32 rounded-full shadow-2xl shadow-gray-500/20 object-cover border-4 border-white dark:border-[#18181b] transition-all duration-300"> -->
                    <img id="avatar-preview" 
     src="{{user.profile.url}}" 
     data-original-src="{{user.profile.url}}"
     alt="User Avatar" 
     class="w-24 h-24 md:w-32 md:h-32 rounded-full object-cover transition-all duration-300
            border-4 border-white dark:border-[#18181b] 
            ring-2 ring-offset-2 ring-offset-white dark:ring-offset-[#18181b]
            {% if user.user_type == 'seller' %}
                ring-brand-purple shadow-[0_0_15px_rgba(121,40,202,0.6)]
            {% else %}
                ring-brand-cyan shadow-[0_0_15px_rgba(0,223,216,0.6)]
            {% endif %}">

                    <label for="avatar-input" id="avatar-overlay"
                        class="hidden absolute inset-0 rounded-full bg-black/50 cursor-pointer items-center justify-center hover:bg-black/60 transition-colors z-10">
                        <i class="fa-solid fa-camera text-white text-2xl"></i>
                    </label>

                    {% if not isDefaultAvatar %}
                    <button id="btn-remove-avatar" onclick="markAvatarForRemoval()" type="button"
                        class="hidden absolute -bottom-2 -right-2 z-20 w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full items-center justify-center shadow-lg transition-colors"
                        title="Remove Profile Picture">
                        <i class="fa-solid fa-trash text-xs"></i>
                    </button>
                    {% endif %}

                    <input type="file" id="avatar-input" name="avatar" accept="image/*" class="hidden"
                        onchange="previewAvatar(this)">
                    <input type="hidden" id="remove-avatar-flag" name="remove_avatar" value="false">
                </div>

                <div class="text-center md:text-left flex-grow">
                    <h1
                        class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white font-mono tracking-tight mb-2">
                        {{ user.username }}
                    </h1>

                    <div class="flex flex-wrap justify-center md:justify-start gap-3">
                        {% if user.user_type == 'seller' %}
                        <span
                            class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-brand-purple/10 text-brand-purple border border-brand-purple/20 font-mono uppercase tracking-wider">
                            <i class="fa-solid fa-store mr-2"></i> Seller_Account
                        </span>
                        {% else %}
                        <span
                            class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-brand-cyan/10 text-brand-cyan border border-brand-cyan/20 font-mono uppercase tracking-wider">
                            <i class="fa-solid fa-cart-shopping mr-2"></i> Buyer_Account
                        </span>
                        {% endif %}

                        {% if user.is_active %}
                        <span
                            class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-green-500/10 text-green-500 border border-green-500/20 font-mono uppercase tracking-wider">
                            <i class="fa-solid fa-circle-check mr-2"></i> Active
                        </span>
                        {% endif %}
                    </div>
                </div>

                <div class="flex flex-col items-end gap-2">
                    <button id="btn-edit" onclick="toggleEditMode(true)"
                        class="inline-flex items-center justify-center px-6 py-2 border border-gray-300 dark:border-gray-700 rounded-lg text-sm font-bold text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors font-mono">
                        <i class="fa-solid fa-pen-to-square mr-2"></i> Edit
                    </button>

                    <div id="actions-edit" class="hidden flex flex-col gap-2 w-full">
                        <button onclick="saveProfile()" id="btn-save"
                            class="inline-flex items-center justify-center px-6 py-2 bg-gradient-to-r from-brand-cyan to-brand-purple text-white rounded-lg text-sm font-bold hover:brightness-110 transition-all font-mono shadow-lg">
                            <i class="fa-solid fa-floppy-disk mr-2"></i> Save
                        </button>
                        <button onclick="toggleEditMode(false)"
                            class="inline-flex items-center justify-center px-6 py-2 border border-red-200 dark:border-red-900 text-red-500 rounded-lg text-sm font-bold hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors font-mono">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="p-8 md:p-10 bg-gray-50/50 dark:bg-black/20">
            <h3
                class="text-sm font-bold text-gray-500 dark:text-gray-400 font-mono uppercase tracking-widest mb-6 border-b border-gray-200 dark:border-gray-800 pb-2">
                User_Parameters
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

                <div class="group">
                    <label class="block text-xs text-gray-500 font-mono mb-1">Email Address</label>
                    <div
                        class="relative flex items-center text-gray-900 dark:text-white font-mono text-lg p-3 bg-white dark:bg-[#1f1f23] rounded-lg border border-gray-200 dark:border-gray-700 transition-colors">
                        <i class="fa-solid fa-envelope text-gray-400 mr-3 text-sm"></i>
                        <span id="display-email">{{ user.email }}</span>
                        <input type="email" id="input-email" value="{{ user.email }}"
                            class="hidden w-full bg-transparent border-b border-brand-purple focus:outline-none focus:border-brand-cyan transition-colors text-gray-900 dark:text-white font-mono">
                    </div>
                </div>

                <div class="group">
                    <label class="block text-xs text-gray-500 font-mono mb-1">Mobile Contact</label>
                    <div
                        class="relative flex items-center text-gray-900 dark:text-white font-mono text-lg p-3 bg-white dark:bg-[#1f1f23] rounded-lg border border-gray-200 dark:border-gray-700 transition-colors">
                        <i class="fa-solid fa-phone text-gray-400 mr-3 text-sm"></i>
                        <span id="display-mobile">{{ user.mobile }}</span>
                        <input type="text" id="input-mobile" value="{{ user.mobile }}"
                            class="hidden w-full bg-transparent border-b border-brand-purple focus:outline-none focus:border-brand-cyan transition-colors text-gray-900 dark:text-white font-mono">
                    </div>
                </div>

                <!-- <div class="group opacity-70">
                    <label class="block text-xs text-gray-500 font-mono mb-1">System Entry Date <span
                            class="text-[10px] text-gray-400">(Read-Only)</span></label>
                    <div
                        class="flex items-center text-gray-900 dark:text-white font-mono text-lg p-3 bg-white dark:bg-[#1f1f23] rounded-lg border border-gray-200 dark:border-gray-700">
                        <i class="fa-solid fa-calendar-day text-gray-400 mr-3 text-sm"></i>
                        {{ user.created_at|date:"F j, Y" }}
                    </div>
                </div> -->

            </div>
        </div>

        <div class="p-6 border-t border-gray-200 dark:border-gray-800 bg-white dark:bg-[#18181b]">
            <p class="text-xs text-center text-gray-400 font-mono">
                User ID: <span class="text-gray-600 dark:text-gray-500">{{ user.pk }}</span> 
                • Last Login: <span class="text-gray-600 dark:text-gray-500">{{ user.last_login|timesince }} ago</span><br>
                • Member Since: <span class="text-gray-600 dark:text-gray-500">{{ user.created_at }}</span>
            </p>
        </div>

    </div>
</div>

<script>
    const defaultAvatarUrl = "{% static 'images/default_avatar.svg' %}";

    // --- NEW: MESSAGE FUNCTION ---
    function showStackmartMessage(text, type = 'success') {
        const container = document.getElementById('ajax-message-container');

        // Define colors based on type (matching your theme)
        let borderColor = 'border-brand-cyan';
        let textColor = 'text-brand-cyan';

        if (type === 'error') {
            borderColor = 'border-red-500';
            textColor = 'text-red-500';
        }

        // Create HTML structure identical to Django messages
        const messageDiv = document.createElement('div');
        messageDiv.className = `p-4 border-l-4 rounded bg-white dark:bg-gray-800 ${borderColor} text-gray-700 dark:text-gray-300 font-mono text-sm shadow-sm dark:shadow-none animate-fade-in-up`;

        messageDiv.innerHTML = `
            <span class="${textColor} font-bold">>>></span> ${text}
        `;

        // Add to container
        container.appendChild(messageDiv);

        // Auto remove after 5 seconds
        setTimeout(() => {
            messageDiv.style.opacity = '0';
            setTimeout(() => messageDiv.remove(), 500); // Wait for fade out
        }, 5000);
    }

    function toggleEditMode(enable) {
        const displayElements = ['display-email', 'display-mobile', 'btn-edit'];
        const inputElements = ['input-email', 'input-mobile', 'actions-edit'];
        const avatarOverlay = document.getElementById('avatar-overlay');
        const removeBtn = document.getElementById('btn-remove-avatar');

        if (enable) {
            displayElements.forEach(id => document.getElementById(id).classList.add('hidden'));
            inputElements.forEach(id => document.getElementById(id).classList.remove('hidden'));
            avatarOverlay.classList.remove('hidden');
            avatarOverlay.classList.add('flex');

            if (removeBtn) {
                removeBtn.classList.remove('hidden');
                removeBtn.classList.add('flex');
            }
        } else {
            displayElements.forEach(id => document.getElementById(id).classList.remove('hidden'));
            inputElements.forEach(id => document.getElementById(id).classList.add('hidden'));
            avatarOverlay.classList.add('hidden');
            avatarOverlay.classList.remove('flex');

            if (removeBtn) {
                removeBtn.classList.add('hidden');
                removeBtn.classList.remove('flex');
            }

            // REVERT CHANGES
            document.getElementById('input-email').value = document.getElementById('display-email').innerText;
            document.getElementById('input-mobile').value = document.getElementById('display-mobile').innerText;

            const img = document.getElementById('avatar-preview');
            img.src = img.getAttribute('data-original-src');
            document.getElementById('avatar-input').value = "";
            document.getElementById('remove-avatar-flag').value = "false";
        }
    }

    function previewAvatar(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('avatar-preview').src = e.target.result;
                document.getElementById('remove-avatar-flag').value = "false";
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    function markAvatarForRemoval() {
        document.getElementById('avatar-preview').src = defaultAvatarUrl;
        document.getElementById('remove-avatar-flag').value = "true";
        document.getElementById('avatar-input').value = "";
    }

    async function saveProfile() {
        const saveBtn = document.getElementById('btn-save');
        const originalText = saveBtn.innerHTML;
        saveBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Saving...';
        saveBtn.disabled = true;

        const formData = new FormData();
        formData.append('email', document.getElementById('input-email').value);
        formData.append('mobile', document.getElementById('input-mobile').value);
        formData.append('remove_avatar', document.getElementById('remove-avatar-flag').value);

        const avatarFile = document.getElementById('avatar-input').files[0];
        if (avatarFile) {
            formData.append('avatar', avatarFile);
        }

        try {
            const response = await fetch("{% url 'profileUpdate' %}", {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            });

            const data = await response.json();

            if (data.status === 'success') {
                document.getElementById('display-email').innerText = document.getElementById('input-email').value;
                document.getElementById('display-mobile').innerText = document.getElementById('input-mobile').value;

                const img = document.getElementById('avatar-preview');
                const newUrl = data.new_avatar_url || defaultAvatarUrl;
                img.src = newUrl;
                img.setAttribute('data-original-src', newUrl);

                const removeBtn = document.getElementById('btn-remove-avatar');
                if (document.getElementById('remove-avatar-flag').value === 'true' && removeBtn) {
                    removeBtn.remove();
                }

                toggleEditMode(false);

                // --- NEW: USE THE CUSTOM MESSAGE ---
                showStackmartMessage(data.message, 'success');

            } else {
                // --- NEW: USE THE CUSTOM MESSAGE FOR ERROR ---
                showStackmartMessage(data.message, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showStackmartMessage("An unexpected error occurred while saving.", 'error');
        } finally {
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }
    }
</script>
{% endblock %}